# Writereader AI Equivalence Experiment
# Switch between GPU and CPU configurations by commenting/uncommenting sections

services:
  wr-ml-service:
    # === Cloud Configuration (GPU deployment) ===
    image: frederikjwritereader/atel:experiment
    ports: 
      - "5001:5000"
    volumes:
      - ./models/modeldir_v1:/modeldir
    environment:
      - MODEL_DIRECTORY=/modeldir
      - INITIAL_MODEL=llama_full
      - MODEL_DEVICE=cuda
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    
    # === Local Configuration (Mac testing) ===
    # Uncomment these and comment out cloud config above for local testing:
    # image: atel:latest
    # ports: 
    #   - "5001:5000"
    # volumes:
    #   - ./models/modeldir_v1:/modeldir
    # environment:
    #   - MODEL_DIRECTORY=/modeldir
    #   - INITIAL_MODEL=llama_full
    #   - MODEL_DEVICE=cpu
    # Remove deploy section for local testing
      
    networks:
      - ml-network
    restart: unless-stopped

  automaticscore:
    # === Cloud Configuration (GPU deployment) ===
    image: frederikjwritereader/automaticscore:experiment
    
    # === Local Configuration (Mac testing) ===
    # Uncomment this line and comment out cloud config above for local testing:
    # image: writereader/automaticscore:experiment
    
    ports:
      - "5002:5000"
    volumes:
      - ./models/autoscoring_v2:/modeldir
    environment:
      - MODEL_DIRECTORY=/modeldir
      - MODEL_DETECT_NOISE=detect_noise/logistic_classifier/model
      - MODEL_EVALUATE_TEXT=evaluate_text/simple
      - API_TEXT_PROPOSAL=http://wr-ml-service:5000/api/textproposal/
      - THRESHOLD_EVALUATE_TEXT=2.0
      - THRESHOLD_DENOISE=0.5
    
    # === Local Configuration (Mac testing) ===
    # Uncomment this line and comment out cloud config above:
    # image: automaticscore:latest
    depends_on:
      - wr-ml-service
    networks:
      - ml-network
    restart: unless-stopped

networks:
  ml-network:
    driver: bridge